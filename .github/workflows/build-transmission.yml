name: Build Transmission Beta ARM64 (Auto + s6-overlay)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'   # 每天检查一次

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      ###############################################
      # 1. 获取最新 s6-overlay 版本
      ###############################################
      - name: Get latest s6-overlay version
        id: s6ver
        run: |
          VERSION=$(curl -s https://api.github.com/repos/just-containers/s6-overlay/releases/latest | jq -r '.tag_name')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest s6-overlay: $VERSION"

      - name: Read current s6-overlay version
        id: s6cur
        run: |
          if [ -f assets/S6_VERSION ]; then
            CUR=$(cat assets/S6_VERSION)
          else
            CUR="none"
          fi
          echo "current=$CUR" >> $GITHUB_OUTPUT
          echo "Current s6-overlay: $CUR"

      ###############################################
      # 2. 获取最新 Transmission Beta Tag
      ###############################################
      - name: Get Latest Transmission Beta Tag
        id: gettag
        run: |
          TAG=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/transmission/transmission/tags?per_page=100" \
            | jq -r '.[].name' | grep beta | head -n 1)
          echo "latest_tag=$TAG" >> $GITHUB_OUTPUT
          echo "Latest Transmission: $TAG"

      - name: Check if Transmission tag exists in GHCR
        id: checkghcr
        run: |
          EXISTS=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://ghcr.io/v2/meng201457/docker-transmission-beta/tags/list \
            | jq -r '.tags[]' | grep -Fx "${{ steps.gettag.outputs.latest_tag }}" || true)
          if [ -n "$EXISTS" ]; then
            echo "skip_transmission=true" >> $GITHUB_OUTPUT
          else
            echo "skip_transmission=false" >> $GITHUB_OUTPUT
          fi

      ###############################################
      # 3. 判断是否需要构建
      ###############################################
      - name: Stop if no updates
        if: |
          steps.s6ver.outputs.version == steps.s6cur.outputs.current &&
          steps.checkghcr.outputs.skip_transmission == 'true'
        run: |
          echo "No updates for s6-overlay or Transmission. Stop."
          exit 0

      ###############################################
      # 4. 下载最新 s6-overlay（如果有更新）
      ###############################################
      - name: Update s6-overlay if needed
        if: steps.s6ver.outputs.version != steps.s6cur.outputs.current
        run: |
          mkdir -p assets
          curl -L -o assets/s6-overlay-aarch64.tar.xz \
            https://ghproxy.net/https://github.com/just-containers/s6-overlay/releases/download/${{ steps.s6ver.outputs.version }}/s6-overlay-aarch64.tar.xz
          echo "${{ steps.s6ver.outputs.version }}" > assets/S6_VERSION

      - name: Commit updated s6-overlay
        if: steps.s6ver.outputs.version != steps.s6cur.outputs.current
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add assets/s6-overlay-aarch64.tar.xz assets/S6_VERSION
          git commit -m "Update s6-overlay to ${{ steps.s6ver.outputs.version }}" || true
          git push || true

      ###############################################
      # 5. 构建 Transmission 镜像
      ###############################################
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64
          push: true
          build-args: |
            TRANSMISSION_TAG=${{ steps.gettag.outputs.latest_tag }}
          tags: |
            ghcr.io/meng201457/docker-transmission-beta:latest
            ghcr.io/meng201457/docker-transmission-beta:${{ steps.gettag.outputs.latest_tag }}
          cache-from: type=registry,ref=ghcr.io/meng201457/docker-transmission-beta:cache
          cache-to: type=registry,ref=ghcr.io/meng201457/docker-transmission-beta:cache,mode=max
